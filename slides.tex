% \pdfpageattr {/Group << /S /Transparency /I true /CS /DeviceRGB>>}
\documentclass[10pt, xcolor={usenames, dvipsnames}]{beamer}

\usepackage[french, english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{upgreek,textgreek}

\usepackage{animate}

\usepackage{ulem}

\usepackage{fontawesome}

\usepackage{changepage}

\usepackage{fnpct}

\usepackage{pifont}
\newcommand{\cmark}{\ding{51}}
\newcommand{\xmark}{\ding{55}}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}

\usepackage{graphicx}
\usepackage{hyperref}
\usepackage[style=alphabetic, autocite=inline, firstinits=true, maxnames=2]{biblatex}
\bibliography{bibliographie}
%\renewcommand*{\bibfont}{\small}

\usepackage{makecell}
\usepackage{tabularx, booktabs}
\usepackage{tikz}
\definecolor{light-gray}{gray}{0.65}
\tikzset{fade on/.code={\only<#1>{\color{light-gray}}}}
\tikzset{hide on/.code={\only<#1>{\color{white}}}}
\tikzset{bold on/.code={\only<#1>{\bfseries}}}
\tikzset{
  opinvisible/.style={opacity=0.2},
  visible on/.style={alt={#1{}{opinvisible}}},
  alt/.code args={<#1>#2#3}{%
    \alt<#1>{\pgfkeysalso{#2}}{\pgfkeysalso{#3}} % \pgfkeysalso doesn't change the path
  },
}

\usetikzlibrary{plotmarks,shapes,patterns}
\usepackage{colortbl}
\usepackage{ulem}
\usepackage{multicol}
\usepackage[overlay]{textpos}
\usepackage{multirow}
\usepackage{ragged2e}
\usepackage{rotating}
\usepackage{fancybox}
\usepackage{ulem}
\usepackage{overpic}
\usepackage{enumerate}
\usepackage{xfrac}
\usepackage{pgfplots}

\usepackage{transparent}

\usepackage{epstopdf}
\usepackage{epsfig}


\newcommand{\REF}{\textcolor{purple}{REF}}
\newcommand{\GO}[1]{\textcolor{blue}{#1}}
\newcommand{\YES}[1]{\textcolor{green}{#1}}
\newcommand{\NO}[1]{\textcolor{red}{#1}}

\newcommand{\BA}[1]{\textcolor{green!80!black!80}{#1}}
\newcommand{\BB}[1]{\textcolor{blue!80!black!80}{#1}}
\newcommand{\BP}[1]{\textcolor{purple!80!black!80}{#1}}
\newcommand{\BF}[1]{\textcolor{yellow!90!black!100}{#1}}

\usetheme{metropolis}

\title{Causal Broadcast: How to Forget?}
\author{Brice N\'edelec, Pascal Molli, and Achour Most{\'e}faoui}
\date{OPODIS'18, Hong Kong, December 17--19.}
\institute{
  \vspace{6em}
  \begin{center}
    \begin{minipage}{0.48\textwidth}
      \centering
      \includegraphics[width=0.5\textwidth]{logos/nantes.png}
    \end{minipage}
    \begin{minipage}{0.48\textwidth}
      \centering
      \includegraphics[width=0.3\textwidth]{logos/ls2n.jpg}
    \end{minipage}
  \end{center}
}



\begin{document}

\maketitle

\begin{frame}{Introduction}

  Causal broadcast is the core of many distributed applications such as
  distributed social networks, distributed collaborative software, or
  distributed data stores.

  \vspace{3em}
  
    \begin{minipage}{0.19\textwidth}
      \centering
      \includegraphics[width=0.7\textwidth]{logos/facebook.png}
    \end{minipage}
    \begin{minipage}{0.19\textwidth}
      \centering
      \includegraphics[width=0.7\textwidth]{logos/mastodon.png}
    \end{minipage}
    \begin{minipage}{0.19\textwidth}
      \centering
      \includegraphics[width=0.7\textwidth]{logos/telegram.png}
    \end{minipage}    
    \begin{minipage}{0.19\textwidth}
      \centering
      \includegraphics[width=0.7\textwidth]{logos/google.png}
    \end{minipage}
    \begin{minipage}{0.19\textwidth}
      \centering
      \includegraphics[width=0.8\textwidth]{logos/riak.png}
    \end{minipage}

    \vspace{4em}  

    \textit{\textbf{What if\ldots} I want to develop fully decentralized
      applications?\ldots}

\end{frame}


\begin{frame}{Causal broadcast ensures causal order}

  Causal broadcast is a \textbf{reliable broadcast} that ensures a
  \textbf{specific ordering} among message deliveries.
  
  \vspace{1em}

  \begin{definition}[Causal order]
    The delivery order of messages follows the Lamport's happen before relationships
    $\rightarrow$ of the corresponding broadcasts.
    $\forall A,\,B,\,C,\, b_A(m) \rightarrow b_B(m') \implies d_C(m) \rightarrow
    d_C(m')$
  \end{definition}
  
  \begin{minipage}{0.49\textwidth}
    % \begin{center}
      \input{input/figtimelineA.tex}
    % \end{center}
  \end{minipage}~~
  \begin{minipage}{0.49\textwidth}
    \begin{center}
      \input{input/figtimelineB.tex}
    \end{center}
  \end{minipage}


\end{frame}


\begin{frame}{Causal broadcast is a reliable broadcast}

  Causal broadcast is a \textbf{reliable broadcast} that ensures a
  \textbf{specific ordering} among message deliveries.
  
  \vspace{1em}

  \begin{definition}[Uniform reliable broadcast] 
    When a process~A broadcasts a message to all processes of its system $b_A(m)$,
    each correct process~B eventually receives it and delivers it
    $d_B(m)$. URB guarantees validity, uniform agreement, and uniform integrity.
    %% 3 properties:
    % \begin{itemize}
    % \item Validity: If a correct process broadcasts a message, then it
    %   eventually delivers it.
    % \item Uniform Agreement: If a process -- correct or not -- delivers a message,
    %   then all correct processes eventually deliver it.
    % \item Uniform Integrity: A process delivers a message at most once, and only if
    %   it was previously broadcast.
    % \end{itemize}
  \end{definition}

  \begin{minipage}{0.49\textwidth} %% fails to receive a message
    %\begin{center}
      \input{input/figtimelineC.tex}\\
      \small\textit{A process must receive every message}
    %\end{center}
  \end{minipage}~~~
  \begin{minipage}{0.49\textwidth} %% multiple deliveries
    \begin{center}
      \input{input/figtimelineD.tex}
      \small\textit{and deliver each message once}
    \end{center}
  \end{minipage}
  
  
  % \vspace{1em}

  % Reliable broadcast forbids multiple delivery.
  
\end{frame}


\begin{frame}{Possible implementations of URB}
  
  \begin{minipage}{0.49\textwidth}
    \begin{center}
      \input{input/figtimelineE.tex}
    \end{center}
  \end{minipage}~
  \begin{minipage}{0.49\textwidth}
    \begin{center}
      \input{input/figtimelineF.tex}
    \end{center}
  \end{minipage}
  \begin{minipage}{0.49\textwidth}
    \vspace{1em}
    Constrain the system topology (e.g. ring or tree) to ensure 1 receipt hence
    1 delivery.\\
    Memory consumption: None \YES{\cmark}\\
    Departures/crashes: \NO{\xmark}
  \end{minipage}~
  \begin{minipage}{0.49\textwidth}
    \vspace{1em}
    Save control information to identify the $1^{st}$ receipt of a
    message and ignore its other receipts.\\
    Memory consumption: $O(N)$ \NO{\xmark}\\
    Departures/crashes: \YES{\cmark}
  \end{minipage}
  
\end{frame}

\begin{frame}[standout]
  
  How to implement an efficient causal broadcast when they rely on reliable
  broadcast implementations that do not scale in large and dynamic systems?
  
  \vspace{2em}
  \large
  (How to implement an efficient reliable broadcast in large and
  dynamic systems?)

\end{frame}

\begin{frame}[standout] 
  How to forget obsolete control information about broadcast messages?
\end{frame}


\begin{frame}{Proposal: PRC-broadcast}

  PRC-broadcast stands for Preventive Reliable Causal broadcast.

  \vspace{1em}
  
  PRC-broadcast exploits the topology without constraining it. It maintains a
  local data structure the size of which does not monotonically increases.

  \vspace{1em}
  
  This implementation of causal broadcast uses the causal order to improve on
  the underlying reliable broadcast implementation.

\end{frame}


\begin{frame}{We define non-monotonic link memory}

  \begin{definition}[Link memory]
    A link from Process~A to Process~B remembers among Process~B's delivered
    messages those that will be received from Process~A; and forgets among
    Process~B's delivered messages those that will never be received from
    Process~A.\\
    $\forall m,\, remember_{BA}(m) \equiv d_B(m) \wedge \neg r_{BA}(m)$
  \end{definition}

  \vspace{2em}

  \begin{theorem}[Link memory forbids multiple delivery]
    Assuming that each link conveys each message at most once, link memory is
    sufficient to forbid multiple delivery.
  \end{theorem}

\end{frame}


\begin{frame}{Large scale static systems: \YES{\cmark}}
  
  reliable links + forwarding + link memory = reliable broadcast\\
  \textit{(Note for later: + FIFO links = causal broadcast)}


  \begin{minipage}{0.24\textwidth}
    \centering
    \input{input/figmemorylinkA.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \vspace{11pt}
    \centering
    \input{input/figmemorylinkB.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \vspace{11pt}
    \centering
    \input{input/figmemorylinkC.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \vspace{1pt}
    \centering
    \input{input/figmemorylinkD.tex}
  \end{minipage}

  \vspace{2em}

  Link memory allows processes to safely remove obsolete control information
  about past deliveries in static systems. 

\end{frame}

\begin{frame}{Dynamic systems: \NO{\xmark}}
  
  \begin{minipage}{0.24\textwidth}
    \centering
    \input{input/figmemorylinkfailsA.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \centering
    \input{input/figmemorylinkfailsB.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \centering
    \input{input/figmemorylinkfailsC.tex}    
  \end{minipage}
  \begin{minipage}{0.24\textwidth}
    \centering
    \input{input/figmemorylinkfailsD.tex}
  \end{minipage}
  
  \vspace{2em}

  Adding a link adds uncertainty. Process~C does not know messages it should
  expect from Process~B. It mistakes the message $a$ for a new one.

  Not only it delivers $a$ multiple times, but this has cascading effects over
  the whole system.

\end{frame}


\begin{frame}{Causal order to initialize link memory}

  \begin{center}
    \input{input/figtimelineproof.tex}
  \end{center}

  \vspace{-1em}

  \begin{minipage}{0.325\textwidth}
    \setbeamercolor{block title}{use=structure,fg=black,bg=green!20}
    \setbeamercolor{block body}{use=structure,fg=black,bg=green!10}
    \begin{block}{Lemma (Buffer $B_\alpha$)}
      $B_\alpha$ contains $\mathcal{A}_2$ and $\mathcal{B}_2$.
    \end{block}
  \end{minipage}
  \begin{minipage}{0.325\textwidth}
    \setbeamercolor{block title}{use=structure,fg=black,bg=blue!20}
    \setbeamercolor{block body}{use=structure,fg=black,bg=blue!10}
    \begin{block}{Lemma (Buffer $B_\beta$)}
      $B_\beta$ contains $\mathcal{B}_2$ and $\mathcal{A}_3$.
    \end{block}
  \end{minipage}
  \begin{minipage}{0.325\textwidth}
    \setbeamercolor{block title}{use=structure,fg=black,bg=purple!20}
    \setbeamercolor{block body}{use=structure,fg=black,bg=purple!10}
    \begin{block}{Lemma (Buffer $B_\pi$)}
      $B_\pi$ contains $\mathcal{A'}_3$ and $\mathcal{B}_3$ with 
      $\mathcal{A}'_3 \subseteq \mathcal{A}_3$.
    \end{block}
  \end{minipage}
  
  \setbeamercolor{block title}{use=structure,fg=black,bg=yellow!20}
  \setbeamercolor{block body}{use=structure,fg=black,bg=yellow!10}
  \begin{block}{Lemma $B_\alpha$, $B_\beta$, $B_\pi$ initialize link memory}
    The memory of a new link becomes correct at receipt of $B_\beta$. \\
    To deliver:
    $B_\beta \setminus B_\alpha \setminus B_\pi = (\mathcal{B}_2 \cup
    \mathcal{A}_3) \setminus (\mathcal{A}_2 \cup \mathcal{B}_2) \setminus
    (\mathcal{A}_3' \cup \mathcal{B}_3) = \mathcal{A}_3 \setminus
    \mathcal{A}_3'$\\
    To expect:
    $B_\pi \setminus B_\beta = (\mathcal{A}_3' \cup \mathcal{B}_3) \setminus
    (\mathcal{B}_2 \cup \mathcal{A}_3) = \mathcal{B}_3$

  \end{block}   
    
\end{frame}

\begin{frame}{Control messages with causal order implement link memory}
  
  \begin{adjustwidth}{-1.5em}{-1.5em}

  \begin{minipage}{0.35\textwidth}
    \raggedright
    \vspace{-7pt}
    \input{input/figsolveA.tex}
  \end{minipage}
  \begin{minipage}{0.36\textwidth}
    \raggedright
    \vspace{-14pt}
    \input{input/figsolveB.tex}
  \end{minipage}
  \begin{minipage}{0.28\textwidth}
    \raggedright
    \input{input/figsolveC.tex}
  \end{minipage}

  \begin{minipage}{0.34\textwidth}
    \raggedright
    \input{input/figsolveD.tex}
  \end{minipage}
  \begin{minipage}{0.34\textwidth}
    \raggedright
    \vspace{9pt}
    \input{input/figsolveE.tex}
  \end{minipage}
  \hspace{5pt}
  \begin{minipage}{0.31\textwidth}
    \raggedright
    \input{input/figsolveF.tex}
  \end{minipage}

  \begin{minipage}{0.53\textwidth}
    \raggedleft
    \input{input/figsolveG.tex}
  \end{minipage}
  \begin{minipage}{0.45\textwidth}
    \centering
    \input{input/figsolveH.tex}        
  \end{minipage}
    

  \end{adjustwidth}

\end{frame}

\begin{frame}{Disambiguation: to deliver, to expect, to ignore}
  
  \begin{adjustwidth}{-1.5em}{-1.5em}
    \begin{center}
    \input{input/figsolveI.tex}
    \end{center}

    \vspace{2em}

    \input{input/figsolveJ.tex}
  \end{adjustwidth}

\end{frame}


\begin{frame}{Complexity}

  \begin{table}
    \begin{center}
      \input{input/tableonelinecomplexity.tex}
    \end{center}
  \end{table}

  TODO figure with number of incoming links and messages still transiting

  Most importantly, this is not grow-only.

\end{frame}

\begin{frame}{Overhead depends on the overlay network}

  \begin{table}
    \begin{center}
      \input{input/tableonelinecomplexity.tex}
    \end{center}
  \end{table}

  \vspace{3em}
  

  \begin{center}
    \begin{table}
      \begin{center}
        \input{input/tableoverhead.tex}
      \end{center}
    \end{table}
  \end{center}

\end{frame}


\begin{frame}{Experiments: setup}
  
  Simulation over Peersim. Code available at \url{http://github.com/chat-wane/peersim-prcbroadcast.git}.

  Overlay network that allows neighbor-to-neighbor connections
  establishement. Random peer-sampling protocol. Very dynamic.
  
  Bidirectional links. Link memory initialized and maintained both ways.
    
\end{frame}

\begin{frame}{Experiments: original tradeoff in space overhead}

  \begin{center}
    \includegraphics[width=0.8\textwidth]{img/overhead.eps}
  \end{center}

\end{frame}

\begin{frame}{Experiments: small traffic overhead}
  \begin{center}
    \includegraphics[width=0.8\textwidth]{img/controlmessages.eps}
  \end{center}
\end{frame}


\begin{frame}{Conclusion}
  
  PRC-broadcast constitutes a new trade-off for causal broadcast.

  \vspace{2em}

  \begin{table}
    \begin{center}
      \input{input/tablecomplexity.tex}
    \end{center}
  \end{table}

  \vspace{2em}

  \faLightbulbO~Fun fact! This implementation of causal broadcast even makes an
  efficient implementation for reliable broadcast.

\end{frame}


\begin{frame}[standout]

  To be continued\ldots Retrieving partial order out of flattened orders.
  
  \vspace{2em}
  
  \begin{center}
    \input{input/figflattened.tex}
  \end{center}
  
\end{frame}


\begin{frame}[standout]

  \vspace{6em}
  
  Thanks!

  \vspace{5em}

  \small
  \faEnvelope ~ brice.nedelec@ls2n.fr

\end{frame}

\end{document}
